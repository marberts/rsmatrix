---
title: "Making repeat-sales indexes"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Making repeat-sales indexes}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(rsmatrix)
library(Matrix)
```

The repeat-sales method is an approach to construct property price indexes by exploiting multiple sales for the same property over time to control for time-invariant differences in quality between properties. In practice, repeat-sales indexes come in a number of different flavors. There are two broad classes
of repeat-sales price indices---the geometric repeat-sales index (GRS index) proposed by Bailey et al. (1963) and the arithmetic repeat-sales index (ARS index) proposed by Shiller (1991)---along with various weighting schemes that can be used to weight the prices in the index calculation (e.g., Case and
Shiller, 1987, 1989; Abraham and Schauman, 1991; Calhoun, 1996). In all cases these indexes can be calculated a linear estimators using the matrices in Shiller (1991, sections I-II). The purpose of the *rsmatrix* package is to make is easy to make these matrices and compute a repeat-sales index.

## Some data

```{r data}
set.seed(15243)

periods <- seq(as.Date("2010-01-01"), as.Date("2019-12-31"), "day")

prices <- data.frame(period = sample(periods, 1e5, TRUE),
                     property = sprintf("%05d", sample(1:5e4, 1e5, TRUE)),
                     price = round(rlnorm(1e5) * 5e5, -3))

prices <- prices[order(prices$property, prices$period), ]
row.names(prices) <- NULL

prices
```


```{r duplicates}
quantile(table(prices$property))
```

## Preparing to make the matrices

```{r pairs}
prices$period <- cut(prices$period, "month")

sales_pairs <- rs_pairs(prices$period, prices$property)
prices[c("period_prev", "price_prev")] <- prices[sales_pairs, c("period", "price")]

prices
```

```{r removal}
prices$holding_period <- with(prices, as.numeric(period) - as.numeric(period_prev))

prices <- subset(prices, holding_period > 2)

monthly_return <- with(prices, (price / price_prev)^(1 / holding_period))

prices <- subset(prices, abs(monthly_return - median(monthly_return)) < 2.5 * mad(monthly_return))

prices
```

## Calculating a repeat-sales index

```{r grs}
matrices <- with(prices, rs_matrix(period, period_prev, price, price_prev))

Z <- matrices("Z")
y <- matrices("y")

grs <- exp(solve(crossprod(Z), crossprod(Z, y)))

X <- matrices("X")
Y <- matrices("Y")

ars <- 1 / solve(crossprod(Z, X), crossprod(Z, Y))
```

## Weighting schemes
